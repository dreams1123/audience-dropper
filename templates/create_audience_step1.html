{% extends "base.html" %}

{% block title %}Create Audience - Step 1{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Create New Audience</h1>
                <p class="text-gray-600 mt-1">Step 1: Chat with our AI to define your target audience</p>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-blue-600 rounded-full"></div>
                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
            </div>
        </div>
    </div>

    <!-- Chatbot Interface -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">AI Audience Researcher</h2>
            <p class="text-sm text-gray-600">I'll help you find the perfect keywords to target your ideal audience. Let's start with some questions about who you're looking for.</p>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="space-y-4 mb-6 max-h-96 overflow-y-auto">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="material-icons text-blue-600 text-sm">smart_toy</span>
                </div>
                <div class="bg-blue-50 rounded-lg p-3 max-w-3xl">
                    <p class="text-sm text-gray-900">Hi! I'm your AI audience researcher. I'll help you find the best keywords to search for your target audience. Let me ask you a few questions to understand who you're looking for.</p>
                </div>
            </div>
            
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="material-icons text-blue-600 text-sm">smart_toy</span>
                </div>
                <div class="bg-blue-50 rounded-lg p-3 max-w-3xl">
                    <p class="text-sm text-gray-900" id="current-question">Who are you looking for?</p>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="flex space-x-3">
            <div class="flex-1">
                <input type="text" id="chat-input" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Type your answer here...">
            </div>
            <button id="send-message" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200 flex items-center">
                <span class="material-icons mr-2">send</span>
                Send
            </button>
        </div>

        <!-- Progress Indicator -->
        <div class="mt-6">
            <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                <span>Progress</span>
                <span id="progress-text">1 of 6 questions</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 16.67%"></div>
            </div>
        </div>
    </div>

    <!-- Keywords Preview (hidden until generated) -->
    <div id="keywords-section" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 hidden">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Generated Keywords</h3>
        <div id="keywords-list" class="flex flex-wrap gap-2 mb-6">
            <!-- Keywords will be populated here -->
        </div>
        <div class="flex justify-end">
            <a href="{{ url_for('audiences.create_audience_step2') }}" 
               class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200">
                Continue to Step 2
            </a>
        </div>
    </div>

    <!-- Navigation -->
    <div class="flex justify-between">
        <a href="{{ url_for('audiences.audiences') }}" 
           class="text-gray-600 hover:text-gray-800 font-medium">
            ‚Üê Back to Audiences
        </a>
        <div class="text-sm text-gray-500">
            Step 1 of 4
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let conversationHistory = [];
let currentQuestionIndex = 0;
const questions = [
    "Who are you looking for?",
    "What type of conversations are you looking for?",
    "What topic in conversations are you looking for?",
    "What product or service do you offer?",
    "Describe the person you want to sell your product or service to?",
    "What are some things the person you are looking for would say if they were asking for your product or service?"
];

document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-message');
    const chatMessages = document.getElementById('chat-messages');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const keywordsSection = document.getElementById('keywords-section');
    const keywordsList = document.getElementById('keywords-list');

    function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-3';
        
        if (isUser) {
            messageDiv.innerHTML = `
                <div class="flex-1"></div>
                <div class="bg-blue-600 rounded-lg p-3 max-w-3xl">
                    <p class="text-sm text-white">${content}</p>
                </div>
                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="material-icons text-gray-600 text-sm">person</span>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="material-icons text-blue-600 text-sm">smart_toy</span>
                </div>
                <div class="bg-blue-50 rounded-lg p-3 max-w-3xl">
                    <p class="text-sm text-gray-900">${content}</p>
                </div>
            `;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateProgress() {
        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
        progressBar.style.width = progress + '%';
        progressText.textContent = `${currentQuestionIndex + 1} of ${questions.length} questions`;
    }

    function sendMessage() {
        const userInput = chatInput.value.trim();
        if (!userInput) return;

        // Add user message
        addMessage(userInput, true);
        conversationHistory.push({ role: 'user', content: userInput });

        // Clear input
        chatInput.value = '';

        // Send to server
        fetch('{{ url_for("audiences.create_audience_step1") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_input: userInput,
                conversation_history: conversationHistory
            })
        })
        .then(response => response.json())
        .then(data => {
            // Add AI response
            addMessage(data.response);
            conversationHistory.push({ role: 'assistant', content: data.response });

            currentQuestionIndex++;

            if (currentQuestionIndex >= questions.length) {
                // Show keywords
                displayKeywords(data.keywords);
            } else {
                updateProgress();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage('Sorry, there was an error. Please try again.');
        });
    }

    function displayKeywords(keywords) {
        keywordsList.innerHTML = '';
        keywords.forEach(keyword => {
            const keywordSpan = document.createElement('span');
            keywordSpan.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800';
            keywordSpan.textContent = keyword;
            keywordsList.appendChild(keywordSpan);
        });
        
        keywordsSection.classList.remove('hidden');
        updateProgress();
    }

    // Event listeners
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Focus input on load
    chatInput.focus();
});
</script>
{% endblock %} 
