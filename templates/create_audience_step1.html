{% extends "base.html" %}

{% block title %}Create Audience - Step 1{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Create New Audience</h1>
                <p class="text-gray-600 mt-1">Step 1: Chat with our AI to define your target audience</p>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-blue-600 rounded-full"></div>
                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">AI Assistant</h2>
            <p class="text-sm text-gray-600">I'll ask you 6 questions to understand your target audience. Answer each question to get personalized keywords and insights.</p>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="space-y-4 mb-6 max-h-96 overflow-y-auto">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="material-icons text-white text-sm">smart_toy</span>
                </div>
                <div class="bg-blue-50 rounded-lg p-3 max-w-3xl">
                    <p class="text-sm text-gray-900">Hello! I'm here to help you identify your target audience. Let me ask you a few questions to understand your business and goals better.</p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="flex space-x-3">
            <input type="text" id="user-input" 
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="Type your answer here...">
            <button id="send-button" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200 flex items-center">
                <span class="material-icons mr-1">send</span>
                Send
            </button>
        </div>
    </div>

    <!-- Results Section (Hidden initially) -->
    <div id="results-section" class="hidden">
        <!-- Quality Assessment -->
        <div id="quality-assessment" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Results Quality Assessment</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="material-icons text-blue-600 text-sm">grade</span>
                        <span class="text-sm font-medium text-gray-900">Quality Score</span>
                    </div>
                    <p class="text-2xl font-bold text-gray-900" id="quality-score">-</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="material-icons text-green-600 text-sm">school</span>
                        <span class="text-sm font-medium text-gray-900">Grade</span>
                    </div>
                    <p class="text-2xl font-bold text-gray-900" id="quality-grade">-</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="material-icons text-purple-600 text-sm">check_circle</span>
                        <span class="text-sm font-medium text-gray-900">Status</span>
                    </div>
                    <p class="text-2xl font-bold text-gray-900" id="proceed-status">-</p>
                </div>
            </div>
            
            <!-- Feedback -->
            <div id="quality-feedback" class="space-y-2">
                <!-- Feedback items will be populated here -->
            </div>
        </div>

        <!-- Generated Keywords -->
        <div id="keywords-section" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Generated Keywords</h3>
            <div id="keywords-list" class="flex flex-wrap gap-2 mb-4">
                <!-- Keywords will be populated here -->
            </div>
            <p class="text-sm text-gray-600">These keywords will be used to search for your target audience across social platforms.</p>
        </div>

        <!-- Summary -->
        <div id="summary-section" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Audience Summary</h3>
            <div id="audience-summary" class="bg-gray-50 rounded-lg p-4">
                <!-- Summary will be populated here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
            <div class="text-sm text-gray-600">
                <span id="keywords-count">0</span> keywords generated
            </div>
            <div class="flex space-x-3">
                <button id="retry-button" 
                        class="border-2 border-gray-300 hover:border-blue-500 text-gray-700 hover:text-blue-600 px-6 py-3 rounded-lg font-medium transition duration-200">
                    Try Again
                </button>
                <a id="next-button" 
                   href="{{ url_for('audiences.create_audience_step2') }}" 
                   class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200 hidden">
                    Continue to Step 2
                </a>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="flex justify-between">
        <a href="{{ url_for('audiences.audiences') }}" 
           class="text-gray-600 hover:text-gray-800 font-medium">
            ‚Üê Back to Audiences
        </a>
        <div class="text-sm text-gray-500">
            Step 1 of 4
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const resultsSection = document.getElementById('results-section');
    const qualityAssessment = document.getElementById('quality-assessment');
    const keywordsSection = document.getElementById('keywords-section');
    const summarySection = document.getElementById('summary-section');
    const nextButton = document.getElementById('next-button');
    const retryButton = document.getElementById('retry-button');
    const qualityScore = document.getElementById('quality-score');
    const qualityGrade = document.getElementById('quality-grade');
    const proceedStatus = document.getElementById('proceed-status');
    const qualityFeedback = document.getElementById('quality-feedback');
    const keywordsList = document.getElementById('keywords-list');
    const keywordsCount = document.getElementById('keywords-count');
    const audienceSummary = document.getElementById('audience-summary');

    let conversationHistory = [];

    // Initial bot message
    addBotMessage("Who are you looking for?");

    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        // Add user message to chat
        addUserMessage(message);
        userInput.value = '';

        // Add to conversation history
        conversationHistory.push({
            role: 'user',
            content: message
        });

        // Send to server
        fetch('{{ url_for("audiences.create_audience_step1") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_input: message,
                conversation_history: conversationHistory
            })
        })
        .then(response => response.json())
        .then(data => {
            // Add bot response to chat
            addBotMessage(data.response);
            conversationHistory.push({
                role: 'assistant',
                content: data.response
            });

            // If we have keywords, show results
            if (data.keywords && data.keywords.length > 0) {
                displayResults(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addBotMessage('Sorry, there was an error processing your response. Please try again.');
        });
    }

    function addUserMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-3 justify-end';
        messageDiv.innerHTML = `
            <div class="bg-blue-600 rounded-lg p-3 max-w-3xl">
                <p class="text-sm text-white">${message}</p>
            </div>
            <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="material-icons text-white text-sm">person</span>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addBotMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-3';
        messageDiv.innerHTML = `
            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="material-icons text-white text-sm">smart_toy</span>
            </div>
            <div class="bg-blue-50 rounded-lg p-3 max-w-3xl">
                <p class="text-sm text-gray-900">${message}</p>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function displayResults(data) {
        // Show results section
        resultsSection.classList.remove('hidden');

        // Display keywords
        keywordsList.innerHTML = '';
        data.keywords.forEach(keyword => {
            const keywordSpan = document.createElement('span');
            keywordSpan.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800';
            keywordSpan.textContent = keyword;
            keywordsList.appendChild(keywordSpan);
        });
        keywordsCount.textContent = data.keywords.length;

        // Display summary if available
        if (data.summary) {
            audienceSummary.innerHTML = `<p class="text-sm text-gray-900">${data.summary}</p>`;
        }

        // Display quality assessment if available
        if (data.results_quality) {
            const quality = data.results_quality;
            qualityScore.textContent = quality.score + '/10';
            qualityGrade.textContent = quality.grade;
            proceedStatus.textContent = data.can_proceed ? 'Ready' : 'Needs Improvement';

            // Display feedback
            qualityFeedback.innerHTML = '';
            quality.feedback.forEach(feedback => {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'flex items-center space-x-2 text-sm text-gray-700';
                feedbackDiv.innerHTML = `
                    <span class="material-icons text-green-600 text-sm">check</span>
                    <span>${feedback}</span>
                `;
                qualityFeedback.appendChild(feedbackDiv);
            });
        }

        // Show/hide next button based on quality
        if (data.show_next_button) {
            nextButton.classList.remove('hidden');
        } else {
            nextButton.classList.add('hidden');
        }
    }

    retryButton.addEventListener('click', function() {
        // Reset conversation
        conversationHistory = [];
        chatMessages.innerHTML = '';
        resultsSection.classList.add('hidden');
        nextButton.classList.add('hidden');
        
        // Start over
        addBotMessage("What type of business or service are you promoting?");
    });
});
</script>
{% endblock %} 
